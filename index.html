<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ä¸‡ç§‘åŒè¯­å­¦æ ¡ 2025 äº”å¹´çº§ å®¶é•¿å¼€æ”¾æ—¥ é€‰è¯¾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { font-family: "PingFang SC", "Microsoft YaHei", Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; margin: 0; padding: 20px; }
    .container { max-width: 1100px; margin: 0 auto; background: white; border-radius: 16px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,.2); position: relative; }
    
    .school-logo { position: absolute; top: 20px; left: 20px; width: 80px; height: auto; z-index: 10; }
    
    h1 { text-align: center; margin: 0 0 10px; font-size: 28px; color: #667eea; padding-top: 10px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 25px; font-size: 14px; line-height: 1.6; }
    .admin-link { text-align: center; margin-bottom: 20px; }
    .admin-link button { background: #10b981; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .admin-link button:hover { background: #059669; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
    .card { background: linear-gradient(145deg, #f8f9ff, #ffffff); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(102,126,234,.15); border: 2px solid #e0e7ff; }
    .card h3 { margin: 0 0 15px; font-size: 18px; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
    .row { margin: 8px 0; font-size: 14px; }
    .label { font-weight: 600; color: #555; }
    .value { margin-left: 6px; color: #333; }
    .remaining { font-size: 20px; font-weight: bold; color: #667eea; }
    .cta { display: inline-block; width: 100%; padding: 12px; margin-top: 12px; border-radius: 8px; border: none; cursor: pointer;
           background: #667eea; color: #fff; font-weight: 600; font-size: 15px; transition: all .3s; }
    .cta:hover:not([disabled]) { background: #5568d3; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,.4); }
    .cta[disabled] { background: #cbd5e1; cursor: not-allowed; transform: none; }
    
    .form-section { background: #f8f9ff; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
    .form-section h2 { margin: 0 0 20px; color: #667eea; font-size: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 14px; }
    .form-group label .required { color: #e11d48; }
    .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 2px solid #e0e7ff; border-radius: 8px; font-size: 14px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.6); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,.3); }
    .modal-content h2 { color: #10b981; margin: 0 0 15px; font-size: 24px; }
    .modal-content .success-icon { font-size: 60px; margin-bottom: 15px; }
    .modal-content p { color: #666; line-height: 1.8; margin: 10px 0; }
    .modal-content .highlight { background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f59e0b; }
    .modal-content button { background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 15px; margin-top: 10px; }
    
    .admin-panel { display: none; padding-top: 70px; }
    .admin-panel.active { display: block; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .admin-header h1 { margin: 0; text-align: left; padding: 0; }
    .admin-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .admin-actions button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all .3s; }
    .btn-export { background: #10b981; color: white; }
    .btn-export:hover { background: #059669; }
    .btn-delete-all { background: #e11d48; color: white; }
    .btn-delete-all:hover { background: #be123c; }
    .btn-delete-single { background: #ef4444; color: white; padding: 6px 12px; font-size: 12px; border-radius: 4px; }
    .btn-delete-single:hover { background: #dc2626; }
    .admin-panel table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
    .admin-panel th, .admin-panel td { border: 1px solid #e0e7ff; padding: 10px; text-align: left; }
    .admin-panel th { background: #667eea; color: white; font-weight: 600; }
    .admin-panel tr:nth-child(even) { background: #f8f9ff; }
    .logout-btn { background: #e11d48; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all .3s; }
    .logout-btn:hover { background: #be123c; }
    
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      .container { padding: 20px; padding-top: 100px; }
      .school-logo { width: 60px; top: 15px; left: 15px; }
      h1 { font-size: 22px; }
      .admin-panel { padding-top: 50px; }
      .admin-panel table { font-size: 11px; }
      .admin-panel th, .admin-panel td { padding: 6px; }
      .admin-header { flex-direction: column; gap: 10px; align-items: flex-start; }
      .admin-header h1 { font-size: 22px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å­¦æ ¡æ ¡å¾½ -->
    <img src="logo.jpg" alt="ä¸‡ç§‘åŒè¯­å­¦æ ¡æ ¡å¾½" class="school-logo" />
    
    <div id="user-view">
      <h1>ğŸ« ä¸‡ç§‘åŒè¯­å­¦æ ¡ 2025 äº”å¹´çº§ å®¶é•¿å¼€æ”¾æ—¥</h1>
      <div class="subtitle">
        <strong>æ´»åŠ¨æ—¥æœŸï¼š2025å¹´11æœˆ21æ—¥</strong><br>
        è¯´æ˜ï¼šæ¯ä½å®¶é•¿åªèƒ½é€‰æ‹©ä¸€èŠ‚è¯¾è§‚æ‘©ï¼Œæ¯èŠ‚è¯¾åé¢ä¸Šé™ä¸º 8 äººï¼Œå…ˆåˆ°å…ˆå¾—ã€‚
      </div>
      
      <div class="admin-link">
        <button onclick="showAdminLogin()">ğŸ‘¤ ç®¡ç†å‘˜ç™»å½•</button>
      </div>

      <!-- æŠ¥åè¡¨å• -->
      <div class="form-section">
        <h2>ğŸ“ æŠ¥åä¿¡æ¯</h2>
        <div class="form-group">
          <label>å­¦ç”Ÿä¸­æ–‡å§“å <span class="required">*</span></label>
          <input type="text" id="student-name-cn" placeholder="è¯·è¾“å…¥å­¦ç”Ÿä¸­æ–‡å§“å" required />
        </div>
        <div class="form-group">
          <label>å­¦ç”Ÿè‹±æ–‡å§“å</label>
          <input type="text" id="student-name-en" placeholder="è¯·è¾“å…¥å­¦ç”Ÿè‹±æ–‡å§“åï¼ˆé€‰å¡«ï¼‰" />
        </div>
        <div class="form-group">
          <label>å­¦ç”Ÿç­çº§ <span class="required">*</span></label>
          <select id="student-class" required>
            <option value="">è¯·é€‰æ‹©ç­çº§</option>
            <option value="äº”å¹´çº§1ç­">äº”å¹´çº§1ç­</option>
            <option value="äº”å¹´çº§2ç­">äº”å¹´çº§2ç­</option>
            <option value="äº”å¹´çº§3ç­">äº”å¹´çº§3ç­</option>
            <option value="äº”å¹´çº§4ç­">äº”å¹´çº§4ç­</option>
            <option value="äº”å¹´çº§5ç­">äº”å¹´çº§5ç­</option>
          </select>
        </div>
        <div class="form-group">
          <label>å®¶é•¿è”ç³»ç”µè¯ <span class="required">*</span></label>
          <input type="tel" id="parent-phone" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç " pattern="[0-9]{11}" required />
        </div>
      </div>

      <!-- è¯¾ç¨‹é€‰æ‹© -->
      <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ“š è¯·é€‰æ‹©è¦è§‚æ‘©çš„è¯¾ç¨‹</h2>
      <div class="grid" aria-label="é€‰è¯¾ä¸‰èŠ‚è¯¾ç¨‹">
        <!-- è¯¾ç¨‹ 1 -->
        <section class="card">
          <h3>P1 - è¯­æ–‡</h3>
          <div class="row"><span class="label">ğŸ‘¨â€ğŸ« è€å¸ˆï¼š</span><span class="value">å´”è€å¸ˆ</span></div>
          <div class="row"><span class="label">â° æ—¶é—´ï¼š</span><span class="value">8:30 - 9:10</span></div>
          <div class="row"><span class="label">ğŸ“Š å‰©ä½™åé¢ï¼š</span><span class="value remaining" id="class1-remaining">8</span></div>
          <button id="class1-signup-btn" class="cta" type="button" onclick="signUpClass('class1')">ç«‹å³æŠ¥å</button>
        </section>

        <!-- è¯¾ç¨‹ 2 -->
        <section class="card">
          <h3>P2 - è‹±è¯­ English</h3>
          <div class="row"><span class="label">ğŸ‘¨â€ğŸ« è€å¸ˆï¼š</span><span class="value">Mr. Franks</span></div>
          <div class="row"><span class="label">â° æ—¶é—´ï¼š</span><span class="value">9:20 - 10:00</span></div>
          <div class="row"><span class="label">ğŸ“Š å‰©ä½™åé¢ï¼š</span><span class="value remaining" id="class2-remaining">8</span></div>
          <button id="class2-signup-btn" class="cta" type="button" onclick="signUpClass('class2')">ç«‹å³æŠ¥å</button>
        </section>

        <!-- è¯¾ç¨‹ 3 -->
        <section class="card">
          <h3>P3 - æ•°å­¦</h3>
          <div class="row"><span class="label">ğŸ‘¨â€ğŸ« è€å¸ˆï¼š</span><span class="value">ä½•è€å¸ˆ</span></div>
          <div class="row"><span class="label">â° æ—¶é—´ï¼š</span><span class="value">10:30 - 11:10</span></div>
          <div class="row"><span class="label">ğŸ“Š å‰©ä½™åé¢ï¼š</span><span class="value remaining" id="class3-remaining">8</span></div>
          <button id="class3-signup-btn" class="cta" type="button" onclick="signUpClass('class3')">ç«‹å³æŠ¥å</button>
        </section>
      </div>
    </div>

    <!-- ç®¡ç†å‘˜é¢æ¿ -->
    <div id="admin-view" class="admin-panel">
      <!-- ç®¡ç†å‘˜é¡¶éƒ¨å¯¼èˆª -->
      <div class="admin-header">
        <h1>ğŸ” ç®¡ç†å‘˜åå°</h1>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
      
      <h2 style="color: #667eea;">ğŸ“‹ æ‰€æœ‰æŠ¥åä¿¡æ¯</h2>
      
      <!-- ç®¡ç†å‘˜æ“ä½œæŒ‰é’® -->
      <div class="admin-actions">
        <button class="btn-export" onclick="exportToExcel()">ğŸ“¥ å¯¼å‡ºä¸ºExcel</button>
        <button class="btn-delete-all" onclick="deleteAllRecords()">ğŸ—‘ï¸ ä¸€é”®åˆ é™¤æ‰€æœ‰</button>
      </div>
      
      <div id="admin-data">
        <table>
          <thead>
            <tr>
              <th>å­¦ç”Ÿä¸­æ–‡å§“å</th>
              <th>å­¦ç”Ÿè‹±æ–‡å§“å</th>
              <th>å­¦ç”Ÿç­çº§</th>
              <th>å®¶é•¿ç”µè¯</th>
              <th>æŠ¥åè¯¾ç¨‹</th>
              <th>æäº¤æ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="admin-table-body">
            <tr><td colspan="7" style="text-align:center; color: #999;">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- æˆåŠŸå¼¹çª— -->
  <div id="success-modal" class="modal">
    <div class="modal-content">
      <div class="success-icon">âœ…</div>
      <h2>æŠ¥åæˆåŠŸï¼</h2>
      <p><strong>å­¦ç”Ÿå§“åï¼š</strong><span id="success-student-name"></span></p>
      <p><strong>æŠ¥åè¯¾ç¨‹ï¼š</strong><span id="success-course"></span></p>
      <div class="highlight">
        <strong>âš ï¸ é‡è¦æé†’ï¼š</strong><br>
        è¯·ç«‹å³æˆªå›¾ä¿å­˜æ­¤é¡µé¢ä½œä¸ºæŠ¥åå‡­è¯ï¼<br>
        æ´»åŠ¨å½“å¤©è¯·æºå¸¦æˆªå›¾å…¥åœºã€‚
      </div>
      <button onclick="closeSuccessModal()">æˆ‘å·²æˆªå›¾</button>
    </div>
  </div>

  <!-- å¼•å…¥SheetJSåº“ç”¨äºExcelå¯¼å‡º -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <script type="module">
    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://vkbs-2025-g5-open-day-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const capacity = 8;
    const courseInfo = {
      class1: { name: 'P1 (8:30-9:10) è¯­æ–‡ï¼ˆå´”è€å¸ˆï¼‰', path: 'courses/class1' },
      class2: { name: 'P2 (9:20-10:00) è‹±è¯­ Englishï¼ˆMr. Franksï¼‰', path: 'courses/class2' },
      class3: { name: 'P3 (10:30-11:10) æ•°å­¦ï¼ˆä½•è€å¸ˆï¼‰', path: 'courses/class3' }
    };

    let isAdmin = false;
    let allSignupsData = []; // å­˜å‚¨æ‰€æœ‰æŠ¥åæ•°æ®ç”¨äºå¯¼å‡º

    // å®æ—¶ç›‘å¬å‰©ä½™åé¢
    function bindRemainingListeners() {
      Object.keys(courseInfo).forEach((courseKey) => {
        const remainingEl = document.getElementById(courseKey + '-remaining');
        const courseRef = ref(db, courseInfo[courseKey].path);
        
        onValue(courseRef, (snap) => {
          const data = snap.val() || {};
          const signups = data.signups || {};
          const used = Object.keys(signups).length;
          const remaining = capacity - used;
          
          if (remainingEl) {
            remainingEl.textContent = remaining;
            remainingEl.style.color = remaining > 0 ? '#667eea' : '#e11d48';
          }
          
          const btn = document.getElementById(courseKey + '-signup-btn');
          if (btn && remaining <= 0) {
            btn.disabled = true;
            btn.textContent = 'å·²æ»¡å‘˜';
          }
        });
      });
    }

    // éªŒè¯è¡¨å•
    function validateForm() {
      const nameCn = document.getElementById('student-name-cn').value.trim();
      const studentClass = document.getElementById('student-class').value;
      const phone = document.getElementById('parent-phone').value.trim();

      if (!nameCn) {
        alert('è¯·è¾“å…¥å­¦ç”Ÿä¸­æ–‡å§“å');
        return false;
      }
      if (!studentClass) {
        alert('è¯·é€‰æ‹©å­¦ç”Ÿç­çº§');
        return false;
      }
      if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ');
        return false;
      }
      return true;
    }

    // æŠ¥åè¯¾ç¨‹
    window.signUpClass = async function(courseKey) {
      if (!validateForm()) return;

      const nameCn = document.getElementById('student-name-cn').value.trim();
      const nameEn = document.getElementById('student-name-en').value.trim();
      const studentClass = document.getElementById('student-class').value;
      const phone = document.getElementById('parent-phone').value.trim();

      // æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²æŠ¥å
      const allCoursesRef = ref(db, 'courses');
      const allCoursesSnap = await get(allCoursesRef);
      const allCourses = allCoursesSnap.val() || {};
      
      let alreadySignedCourse = null;
      for (let ck in allCourses) {
        const signups = allCourses[ck].signups || {};
        for (let sid in signups) {
          if (signups[sid].phone === phone) {
            alreadySignedCourse = ck;
            break;
          }
        }
        if (alreadySignedCourse) break;
      }

      if (alreadySignedCourse && alreadySignedCourse !== courseKey) {
        const confirmMsg = `è¯¥æ‰‹æœºå·å·²æŠ¥å${courseInfo[alreadySignedCourse].name}ï¼Œæ˜¯å¦åˆ‡æ¢åˆ°${courseInfo[courseKey].name}ï¼Ÿ`;
        if (!confirm(confirmMsg)) return;
      }

      const courseRef = ref(db, courseInfo[courseKey].path);
      
      const result = await runTransaction(courseRef, (current) => {
        if (!current) current = {};
        if (!current.signups) current.signups = {};
        
        const signups = current.signups;
        const occupied = Object.keys(signups).length;
        
        if (occupied >= capacity) {
          return; // å·²æ»¡
        }
        
        const signupId = 'signup_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        signups[signupId] = {
          studentNameCn: nameCn,
          studentNameEn: nameEn,
          studentClass: studentClass,
          phone: phone,
          timestamp: new Date().toISOString(),
          course: courseInfo[courseKey].name
        };
        
        current.signups = signups;
        return current;
      });

      if (!result.committed) {
        alert('æŠ¥åå¤±è´¥ï¼šè¯¥è¯¾ç¨‹å·²æ»¡å‘˜ï¼Œè¯·é€‰æ‹©å…¶ä»–è¯¾ç¨‹ã€‚');
        return;
      }

      // å¦‚æœä¹‹å‰æŠ¥åäº†å…¶ä»–è¯¾ç¨‹ï¼Œåˆ é™¤æ—§çš„æŠ¥å
      if (alreadySignedCourse && alreadySignedCourse !== courseKey) {
        const oldCourseRef = ref(db, courseInfo[alreadySignedCourse].path);
        await runTransaction(oldCourseRef, (current) => {
          if (!current || !current.signups) return current;
          const signups = current.signups;
          for (let sid in signups) {
            if (signups[sid].phone === phone) {
              delete signups[sid];
              break;
            }
          }
          return current;
        });
      }

      // æ˜¾ç¤ºæˆåŠŸå¼¹çª—
      document.getElementById('success-student-name').textContent = nameCn;
      document.getElementById('success-course').textContent = courseInfo[courseKey].name;
      document.getElementById('success-modal').classList.add('active');
    };

    window.closeSuccessModal = function() {
      document.getElementById('success-modal').classList.remove('active');
      // æ¸…ç©ºè¡¨å•
      document.getElementById('student-name-cn').value = '';
      document.getElementById('student-name-en').value = '';
      document.getElementById('student-class').value = '';
      document.getElementById('parent-phone').value = '';
    };

    // ç®¡ç†å‘˜ç™»å½•
    window.showAdminLogin = function() {
      const username = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜ç”¨æˆ·åï¼š');
      const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š');
      
      if (username === 'admin' && password === '123') {
        isAdmin = true;
        document.getElementById('user-view').style.display = 'none';
        document.getElementById('admin-view').classList.add('active');
        loadAdminData();
      } else {
        alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼');
      }
    };

    window.logout = function() {
      isAdmin = false;
      document.getElementById('user-view').style.display = 'block';
      document.getElementById('admin-view').classList.remove('active');
    };

    // åˆ é™¤å•æ¡è®°å½•
    window.deleteSingleRecord = async function(courseKey, signupId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æŠ¥åè®°å½•å—ï¼Ÿ')) return;
      
      try {
        const signupRef = ref(db, `${courseInfo[courseKey].path}/signups/${signupId}`);
        await remove(signupRef);
        alert('åˆ é™¤æˆåŠŸï¼');
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥ï¼š', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
      }
    };

    // ä¸€é”®åˆ é™¤æ‰€æœ‰è®°å½•
    window.deleteAllRecords = async function() {
      const confirmation = prompt('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æŠ¥åè®°å½•ï¼\n\nè¯·è¾“å…¥"ç¡®è®¤åˆ é™¤"ä»¥ç»§ç»­ï¼š');
      
      if (confirmation !== 'ç¡®è®¤åˆ é™¤') {
        alert('æ“ä½œå·²å–æ¶ˆ');
        return;
      }

      try {
        const allCoursesRef = ref(db, 'courses');
        await remove(allCoursesRef);
        alert('æ‰€æœ‰è®°å½•å·²åˆ é™¤ï¼');
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥ï¼š', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
      }
    };

    // å¯¼å‡ºä¸ºExcel
    window.exportToExcel = function() {
      if (allSignupsData.length === 0) {
        alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
        return;
      }

      // å‡†å¤‡Excelæ•°æ®
      const excelData = allSignupsData.map(signup => ({
        'å­¦ç”Ÿä¸­æ–‡å§“å': signup.studentNameCn,
        'å­¦ç”Ÿè‹±æ–‡å§“å': signup.studentNameEn || '-',
        'å­¦ç”Ÿç­çº§': signup.studentClass,
        'å®¶é•¿ç”µè¯': signup.phone,
        'æŠ¥åè¯¾ç¨‹': signup.course,
        'æäº¤æ—¶é—´': new Date(signup.timestamp).toLocaleString('zh-CN')
      }));

      // åˆ›å»ºå·¥ä½œç°¿
      const ws = XLSX.utils.json_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'æŠ¥åä¿¡æ¯');

      // è®¾ç½®åˆ—å®½
      ws['!cols'] = [
        { wch: 15 }, // å­¦ç”Ÿä¸­æ–‡å§“å
        { wch: 20 }, // å­¦ç”Ÿè‹±æ–‡å§“å
        { wch: 12 }, // å­¦ç”Ÿç­çº§
        { wch: 15 }, // å®¶é•¿ç”µè¯
        { wch: 35 }, // æŠ¥åè¯¾ç¨‹
        { wch: 20 }  // æäº¤æ—¶é—´
      ];

      // ç”Ÿæˆæ–‡ä»¶å
      const fileName = `ä¸‡ç§‘åŒè¯­å­¦æ ¡å®¶é•¿å¼€æ”¾æ—¥æŠ¥å_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.xlsx`;

      // å¯¼å‡º
      XLSX.writeFile(wb, fileName);
    };

    // åŠ è½½ç®¡ç†å‘˜æ•°æ®
    function loadAdminData() {
      const allCoursesRef = ref(db, 'courses');
      onValue(allCoursesRef, (snap) => {
        const courses = snap.val() || {};
        const tbody = document.getElementById('admin-table-body');
        tbody.innerHTML = '';
        
        allSignupsData = []; // æ¸…ç©ºå¹¶é‡æ–°æ”¶é›†æ•°æ®
        
        for (let courseKey in courses) {
          const signups = courses[courseKey].signups || {};
          for (let signupId in signups) {
            const signup = signups[signupId];
            signup._courseKey = courseKey; // ä¿å­˜è¯¾ç¨‹keyç”¨äºåˆ é™¤
            signup._signupId = signupId;   // ä¿å­˜æŠ¥åIDç”¨äºåˆ é™¤
            allSignupsData.push(signup);
          }
        }
        
        // æŒ‰æ—¶é—´æ’åº
        allSignupsData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        if (allSignupsData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: #999;">æš‚æ— æŠ¥åæ•°æ®</td></tr>';
        } else {
          allSignupsData.forEach(signup => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = signup.studentNameCn;
            row.insertCell(1).textContent = signup.studentNameEn || '-';
            row.insertCell(2).textContent = signup.studentClass;
            row.insertCell(3).textContent = signup.phone;
            row.insertCell(4).textContent = signup.course;
            row.insertCell(5).textContent = new Date(signup.timestamp).toLocaleString('zh-CN');
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®
            const actionCell = row.insertCell(6);
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.className = 'btn-delete-single';
            deleteBtn.onclick = () => deleteSingleRecord(signup._courseKey, signup._signupId);
            actionCell.appendChild(deleteBtn);
          });
        }
      });
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      bindRemainingListeners();
    });
  </script>
</body>
</html>
