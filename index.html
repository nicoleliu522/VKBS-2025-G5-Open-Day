<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>万科双语学校 2025 五年级 家长开放日 选课</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fb; color: #333; margin: 0; padding: 0; }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    h1 { text-align: center; margin: 20px 0 10px; font-size: 28px; }
    .subtitle { text-align: center; color: #555; margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    .card h3 { margin: 6px 0 6px; font-size: 16px; }
    .row { margin: 6px 0; }
    .label { font-weight: 600; color: #555; }
    .value { margin-left: 6px; color: #333; }
    .muted { color: #777; font-size: 12px; }
    .cta { display: inline-block; padding: 10px 14px; margin-top: 8px; border-radius: 8px; border: none; cursor: pointer;
           background: #4f46e5; color: #fff; font-weight: 600; }
    .cta[disabled] { background: #9aa4b2; cursor: not-allowed; }
    #cancel-btn { display: block; width: max-content; margin: 22px auto; background: #e11d48; }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
  <script type="module">
    // 1) 将你的 Firebase 配置填在这里
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://vkbs-2025-g5-open-day-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // 2) 引入 Firebase 依赖
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, set, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // 3) 初始化
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // 4) 全局状态
    let uid = null;
    let userSignedClass = null; // 'class1' | 'class2' | 'class3' 或 null

    // 5) 匿名登录
    signInAnonymously(auth).catch((error) => {
      console.error("Anonymous sign-in error:", error);
    });

    // 6) 监听登录状态，获取 uid
    onAuthStateChanged(auth, (user) => {
      if (user) {
        uid = user.uid;
        // 监听用户选择的班级
        const userSignupRef = ref(db, 'users/' + uid + '/signup_class');
        onValue(userSignupRef, (snap) => {
          userSignedClass = snap.val() || null;
          updateSignupStatusUI();
        });
      }
    });

    // 7) 课程信息
    const capacity = 8;
    const classPaths = {
      class1: 'open_day/2025-11-21/G7/Grade5/Class1/signups',
      class2: 'open_day/2025-11-21/G7/Grade5/Class2/signups',
      class3: 'open_day/2025-11-21/G7/Grade5/Class3/signups'
    };

    // 8) 实时显示剩余名额
    function bindRemainingListeners() {
      Object.keys(classPaths).forEach((clsKey) => {
        const remainingEl = document.getElementById(clsKey + '-remaining');
        const signupsRef = ref(db, classPaths[clsKey]);
        onValue(signupsRef, (snap) => {
          const data = snap.val() || {};
          const used = Object.keys(data).length;
          const remaining = capacity - used;
          if (remainingEl) remainingEl.textContent = remaining;
          // 按钮状态
          const btn = document.getElementById(clsKey + '-signup-btn');
          if (btn) {
            if (data[uid]) {
              btn.disabled = true;
              btn.textContent = '已报名';
            } else {
              btn.disabled = false;
              btn.textContent = '报名';
            }
          }
        }, { 'returnInitialValue': true });
      });
    }

    function updateSignupStatusUI() {
      ['class1','class2','class3'].forEach((cls) => {
        const btn = document.getElementById(cls + '-signup-btn');
        if (!btn) return;
        if (userSignedClass === cls) {
          btn.disabled = true;
          btn.textContent = '已报名';
        } else {
          btn.disabled = false;
          btn.textContent = '报名';
        }
      });
      const cancelBtn = document.getElementById('cancel-btn');
      if (cancelBtn) cancelBtn.style.display = userSignedClass ? 'inline-block' : 'none';
    }

    async function signUpClass(clsKey) {
      if (!uid) {
        alert('正在初始化，请稍后再试');
        return;
      }
      if (userSignedClass && userSignedClass !== clsKey) {
        const confirmSwitch = confirm('你已报名其他班级，是否切换报名？本操作将取消原报名并报名新班级。');
        if (!confirmSwitch) return;
      }
      const classSignupsRef = ref(db, classPaths[clsKey]);

      const res = await runTransaction(classSignupsRef, (current) => {
        if (current == null) current = {};
        if (current[uid]) return current;
        const occupied = Object.keys(current).length;
        if (occupied >= capacity) return; // 已满
        current[uid] = true;
        return current;
      });

      if (!res.committed) {
        alert('报名失败：该班级席位已满，请选择其他班级或稍后再试。');
        return;
      }

      // 取消旧班级的报名
      if (userSignedClass && userSignedClass !== clsKey) {
        const oldRef = ref(db, classPaths[userSignedClass]);
        await runTransaction(oldRef, (oldCurrent) => {
          if (oldCurrent && oldCurrent[uid]) delete oldCurrent[uid];
          return oldCurrent;
        });
      }

      // 记录用户的报名班级
      const userSignupRef = ref(db, 'users/' + uid + '/signup_class');
      await set(userSignupRef, clsKey);

      userSignedClass = clsKey;
      updateSignupStatusUI();
      alert('报名成功！');
    }

    async function cancelSignup() {
      if (!uid || !userSignedClass) {
        alert('尚未报名任何班级');
        return;
      }
      const currRef = ref(db, classPaths[userSignedClass]);
      await runTransaction(currRef, (current) => {
        if (current && current[uid]) delete current[uid];
        return current;
      });
      const userSignupRef = ref(db, 'users/' + uid + '/signup_class');
      await remove(userSignupRef);

      userSignedClass = null;
      updateSignupStatusUI();
      alert('已取消报名');
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('class1-signup-btn').addEventListener('click', () => signUpClass('class1'));
      document.getElementById('class2-signup-btn').addEventListener('click', () => signUpClass('class2'));
      document.getElementById('class3-signup-btn').addEventListener('click', () => signUpClass('class3'));

      document.getElementById('cancel-btn').addEventListener('click', cancelSignup);

      bindRemainingListeners();
      updateSignupStatusUI();
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>万科双语学校 2025 年级五年级 家长开放日 选课</h1>
    <div class="subtitle">说明：每位家长只能在三节课中选择一节，且每节课名额上限为 8 人。数据实时更新。</div>

    <div class="grid" aria-label="选课三节课程">
      <!-- 课程 1 -->
      <section class="card" id="card-class1">
        <h3>P1 - G7 语文</h3>
        <div class="row"><span class="label">老师：</span><span class="value">崔爱旋</span></div>
        <div class="row"><span class="label">时段：</span><span class="value">P1</span></div>
        <div class="row"><span class="label">剩余名额：</span><span class="value" id="class1-remaining">8</span></div>
        <button id="class1-signup-btn" class="cta" type="button" disabled>报名</button>
      </section>

      <!-- 课程 2 -->
      <section class="card" id="card-class2">
        <h3>P2 - G7 English</h3>
        <div class="row"><span class="label">老师：</span><span class="value">Mr.William Franks</span></div>
        <div class="row"><span class="label">时段：</span><span class="value">P2</span></div>
        <div class="row"><span class="label">剩余名额：</span><span class="value" id="class2-remaining">8</span></div>
        <button id="class2-signup-btn" class="cta" type="button" disabled>报名</button>
      </section>

      <!-- 课程 3 -->
      <section class="card" id="card-class3">
        <h3>P3 - G7 Math</h3>
        <div class="row"><span class="label">老师：</span><span class="value">何春利</span></div>
        <div class="row"><span class="label">时段：</span><span class="value">P3</span></div>
        <div class="row"><span class="label">剩余名额：</span><span class="value" id="class3-remaining">8</span></div>
        <button id="class3-signup-btn" class="cta" type="button" disabled>报名</button>
      </section>
    </div>

    <div style="text-align:center">
      <button id="cancel-btn" class="cta" style="background:#e11d48; display:none;" type="button">取消我的报名</button>
    </div>
  </div>
</body>
</html>
